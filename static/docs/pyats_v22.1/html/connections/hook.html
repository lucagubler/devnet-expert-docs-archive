<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connection Hook &mdash; pyATS Documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Connection Sharing" href="sharing.html" />
    <link rel="prev" title="Connection Class" href="class.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pyATS
          </a>
              <div class="version">
                24.11
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Main Components</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../aetest/index.html">AEtest - Test Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../easypy/index.html">Easypy - Runtime Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../topology/index.html">Testbed &amp; Topology Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kleenex/index.html">Testbed &amp; Device Cleaning</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Connection Meta</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration.html">Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="manager.html">Connection Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="class.html">Connection Class</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Connection Hook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sharing.html">Connection Sharing</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Supporting Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../async/index.html">Asynchronous Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datastructures/index.html">Datastructures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tcl/index.html">Tcl Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log/index.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../results/index.html">Result Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporter/index.html">Reporter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../robot/index.html">RobotFramework Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../manifest/index.html">Manifest</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources/index.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog/index.html">Changelog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Doc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apidoc/index.html">API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pyATS</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Connection Meta</a></li>
      <li class="breadcrumb-item active">Connection Hook</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="connection-hook">
<h1>Connection Hook<a class="headerlink" href="#connection-hook" title="Permalink to this heading">¶</a></h1>
<p>Whereas a connection class provides the fundamentals of communicating to target
devices using object methods (<strong>services</strong>), the goal of a connection hook is
to <em>tap</em> onto particular services and <em>inject</em> code to run before and after the
actual service call, <strong>without modifying</strong> the original behavior.</p>
<p>Here are some typical use cases of connection hooks:</p>
<blockquote>
<div><ul class="simple">
<li><p>tracking the sequence/occurance of CLI command calls throughout a script</p></li>
<li><p>debug-logging the input arguments to, and output values from particular
services.</p></li>
<li><p>building a LRU cache based on script inputs and device states.</p></li>
<li><p>etc.</p></li>
</ul>
</div></blockquote>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p>A connection hook wraps the original connection service method, and replaces it
during runtime (dynamically). The original functionality of the service remains
intact, but the hook enables uses to add code before/after the service method.</p>
<ul class="simple">
<li><p>all connection hooks should inherit the base <code class="docutils literal notranslate"><span class="pre">connections.hooks.ServiceHook</span></code>
class</p></li>
<li><p>to add code <em>before a service</em>, define the <code class="docutils literal notranslate"><span class="pre">enter()</span></code> method under your
class.</p>
<ul>
<li><p>all arguments to the service is passed to <code class="docutils literal notranslate"><span class="pre">enter()</span></code> method in the same way
as the original call.</p></li>
</ul>
</li>
<li><p>to execute code <em>after a service</em>, define the <code class="docutils literal notranslate"><span class="pre">after()</span></code> method under your
class</p>
<ul>
<li><p>the return of the service is passed to the <code class="docutils literal notranslate"><span class="pre">after()</span></code> method</p></li>
</ul>
</li>
<li><p>to enable custom error/exception tracking, define a <code class="docutils literal notranslate"><span class="pre">error_handle()</span></code> method
under you class.</p>
<ul>
<li><p>the current exception is passed into the error handler as <code class="docutils literal notranslate"><span class="pre">e</span></code>.</p></li>
</ul>
</li>
<li><p>to disable the current hook, call the <code class="docutils literal notranslate"><span class="pre">restore()</span></code> method of the hook.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>error handlers can suppress an exception, and/or track/register it
internally. By default the built-in error handler will simply raise the
current exception. Developer can modify that to suppress the current
exception being handled, and return a fixed/altered result.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example</span>
<span class="c1"># -------</span>
<span class="c1">#</span>
<span class="c1">#   a simple tracking implementation</span>

<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="kn">from</span> <span class="nn">pyats.connections.hooks</span> <span class="kn">import</span> <span class="n">ServiceHook</span>

<span class="k">class</span> <span class="nc">Tracker</span><span class="p">(</span><span class="n">ServiceHook</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;A hook implementation intended to count the number of CLI calls, and</span>
<span class="sd">    track their result returns&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># always call the parent</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># create a local counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>

        <span class="c1"># create a command return storage dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;enter</span>

<span class="sd">        Track the command occurance (calls) by assuming execute() command&#39;s</span>
<span class="sd">        first argument is the CLI command to run, and ignoring the rest of</span>
<span class="sd">        the arguments</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># increment the counter</span>
        <span class="c1"># (using this command as key)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># store the current command for use in exit()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>

    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;exit</span>

<span class="sd">        store the return from the command call in another dictionary</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># the current command from enter()</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span>

        <span class="c1"># current command occurance</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span>

        <span class="c1"># because a command can be called multiple times, store each</span>
        <span class="c1"># possible command using a dictionary with their counter as index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># now store the return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returns</span><span class="p">[</span><span class="n">cmd</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">retval</span>

    <span class="k">def</span> <span class="nf">error_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;error_handle</span>

<span class="sd">        This dummy handler will just print the current exception and go into</span>
<span class="sd">        pdb - that could be very useful!</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">            for demonstration purpose only.</span>

<span class="sd">            NEVER do this in production :) you will BLOCK sanity/regression</span>
<span class="sd">            automated runs.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1"># go into pdb</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="c1"># re-raise the exception</span>
        <span class="c1"># (default behavior)</span>
        <span class="k">raise</span>


<span class="c1"># now that we&#39;ve defined a hook implementation</span>
<span class="c1"># let&#39;s hook an actual device.</span>
<span class="c1"># -----------------------------------------------------------</span>

<span class="c1"># assuming we have a testbed from somewhere</span>
<span class="kn">from</span> <span class="nn">pyats.topology</span> <span class="kn">import</span> <span class="n">loader</span>
<span class="n">testbed</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/path/to/testbed.yaml&#39;</span><span class="p">)</span>

<span class="c1"># get the device and connect to it</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">testbed</span><span class="o">.</span><span class="n">devices</span><span class="p">[</span><span class="s1">&#39;my-device&#39;</span><span class="p">]</span>
<span class="n">device</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># use our hook and hook onto the execute() service</span>
<span class="n">hook</span> <span class="o">=</span> <span class="n">Tracker</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s1">&#39;execute&#39;</span><span class="p">)</span>
<span class="c1"># note that device.execute is actually device.connections[&#39;default&#39;].execute</span>
<span class="c1"># as per connection manager integration with device objects.</span>
<span class="c1"># thus it&#39;s actually more accurate to hook onto the connection itself</span>
<span class="c1"># eg:</span>
<span class="c1">#   hook = Tracker(device.connections[&#39;default&#39;], &#39;execute&#39;)</span>

<span class="c1"># from here onwards, all calls to device.execute() will be tracked</span>
<span class="n">device</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show version&#39;</span><span class="p">)</span>
<span class="n">device</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show ip interface brief&#39;</span><span class="p">)</span>

<span class="c1"># the returned hook instance can be used to check the hook returns &amp; etc</span>
<span class="n">hook</span><span class="o">.</span><span class="n">counter</span>
<span class="n">hook</span><span class="o">.</span><span class="n">returns</span>

<span class="c1"># to disable the hook behavior, call the restore() api.</span>
<span class="n">hook</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
<span class="c1"># this will restore the original functionality and disable the hook</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="class.html" class="btn btn-neutral float-left" title="Connection Class" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="sharing.html" class="btn btn-neutral float-right" title="Connection Sharing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) 2024, Cisco Systems Inc..
      <span class="lastupdated">Last updated on Dec 27, 2024.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>