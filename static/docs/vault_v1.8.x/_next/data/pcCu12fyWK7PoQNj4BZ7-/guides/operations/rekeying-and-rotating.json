{"pageProps":{"currentPath":"operations/rekeying-and-rotating","frontMatter":{"layout":"guides","page_title":"Rekeying & Rotating Vault - Guides","description":"Vault supports generating new unseal keys as well as rotating the underlying\nencryption keys. This guide covers rekeying and rotating Vault's encryption\nkeys."},"githubFileUrl":"https://github.com/hashicorp/vault/blob/main/website/content/guides/operations/rekeying-and-rotating.mdx","mdxSource":{"compiledSource":"var m=Object.defineProperty;var o=Object.prototype.hasOwnProperty;var r=Object.getOwnPropertySymbols,l=Object.prototype.propertyIsEnumerable;var i=(a,t,s)=>t in a?m(a,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[t]=s,e=(a,t)=>{for(var s in t||(t={}))o.call(t,s)&&i(a,s,t[s]);if(r)for(var s of r(t))l.call(t,s)&&i(a,s,t[s]);return a};var p=(a,t)=>{var s={};for(var n in a)o.call(a,n)&&t.indexOf(n)<0&&(s[n]=a[n]);if(a!=null&&r)for(var n of r(a))t.indexOf(n)<0&&l.call(a,n)&&(s[n]=a[n]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var n=s,{components:a}=n,t=p(n,[\"components\"]);return mdx(MDXLayout,e(e(e({},layoutProps),t),{components:a,mdxType:\"MDXLayout\"}),mdx(\"h1\",e({},{className:\"g-type-display-2\"}),mdx(\"a\",e({parentName:\"h1\"},{className:\"__permalink-h\",href:\"#rekeying-rotating-vault\",\"aria-label\":\"rekeying rotating vault permalink\"}),\"\\xBB\"),mdx(\"a\",e({parentName:\"h1\"},{className:\"__target-h\",id:\"rekeying-rotating-vault\",\"aria-hidden\":\"\"})),\"Rekeying \",\"&\",\" Rotating Vault\"),mdx(\"div\",e({},{className:\"alert alert-warning g-type-body\",role:\"alert\"}),mdx(\"p\",e({parentName:\"div\"},{className:\"g-type-long-body\"}),\"\",mdx(\"strong\",{parentName:\"p\"},\"Advanced Topic\"),` This guide presents an advanced topic that is not required\nfor a basic understanding of Vault. Knowledge of this topic is not required for\ndaily Vault use.`)),mdx(\"h2\",e({},{className:\"g-type-display-3\"}),mdx(\"a\",e({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#background\",\"aria-label\":\"background permalink\"}),\"\\xBB\"),mdx(\"a\",e({parentName:\"h2\"},{className:\"__target-h\",id:\"background\",\"aria-hidden\":\"\"})),\"Background\"),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`In order to prevent no one person from having complete access to the system,\nVault employs `,mdx(\"a\",e({parentName:\"p\"},{href:\"https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing\"}),\"Shamir's Secret Sharing Algorithm\"),`. Under this process,\na secret is divided into a subset of parts such that a subset of those parts are\nneeded to reconstruct the original secret. Vault makes heavy use of this\nalgorithm as part of the `,mdx(\"a\",e({parentName:\"p\"},{href:\"/docs/concepts/seal\"}),\"unsealing process\"),\".\"),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`When a Vault server is first initialized, Vault generates a master key and\nimmediately splits this master key into a series of key shares following\nShamir's Secret Sharing Algorithm. Vault never stores the master key, therefore,\nthe only way to retrieve the master key is to have a quorum of unseal keys\nre-generate it.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`The master key is used to decrypt the underlying encryption key. Vault uses the\nencryption key to encrypt data at rest in a storage backend like the filesystem\nor Consul.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`Typically each of these key shares is distributed to trusted parties in the\norganization. These parties must come together to \"unseal\" the Vault by entering\ntheir key share.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),mdx(\"a\",e({parentName:\"p\"},{href:\"/img/vault-shamir-secret-sharing.svg\"}),mdx(\"img\",e({parentName:\"a\"},{src:\"/img/vault-shamir-secret-sharing.svg\",alt:\"Vault Shamir Secret Sharing Algorithm\"})))),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`In some cases, you may want to re-generate the master key and key shares. Here\nare a few examples:`),mdx(\"ul\",null,mdx(\"li\",e({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"Someone joins or leaves the organization\"),mdx(\"li\",e({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"Security wants to change the number of shares or threshold of shares\"),mdx(\"li\",e({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"Compliance mandates the master key be rotated at a regular interval\")),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`In addition to rekeying the master key, there may be an independent desire to\nrotate the underlying encryption key Vault uses to encrypt data at rest.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),mdx(\"a\",e({parentName:\"p\"},{href:\"/img/vault-rekey-vs-rotate.svg\"}),mdx(\"img\",e({parentName:\"a\"},{src:\"/img/vault-rekey-vs-rotate.svg\",alt:\"Vault Rekey vs Rotate\"})))),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"In Vault, \",mdx(\"em\",{parentName:\"p\"},\"rekeying\"),\" and \",mdx(\"em\",{parentName:\"p\"},\"rotating\"),` are two separate operations. The process for\ngenerating a new master key and applying Shamir's algorithm is called\n\"rekeying\". The process for generating a new encryption key for Vault to encrypt\ndata at rest is called \"rotating\".`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`Both rekeying the Vault and rotating Vault's underlying encryption key are fully\nonline operations. Vault will continue to service requests uninterrupted during\neither of these processes.`),mdx(\"h2\",e({},{className:\"g-type-display-3\"}),mdx(\"a\",e({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#rekeying-vault\",\"aria-label\":\"rekeying vault permalink\"}),\"\\xBB\"),mdx(\"a\",e({parentName:\"h2\"},{className:\"__target-h\",id:\"rekeying-vault\",\"aria-hidden\":\"\"})),\"Rekeying Vault\"),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`Rekeying the Vault requires a quorum of unseal keys. Before continuing, you\nshould ensure enough unseal key holders are available to assist with the\nrekeying to match the threshold configured when the keys were issued.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"Please also observe that if Vault is configured with \",mdx(\"em\",{parentName:\"p\"},\"auto_unseal\"),\" (and the keys thus are the \",mdx(\"em\",{parentName:\"p\"},\"recovery_keys\"),\"), an extra flag \",mdx(\"inlineCode\",{parentName:\"p\"},\"-target=recovery\"),\" has to be provided for each of the commands below. Otherwise the \",mdx(\"em\",{parentName:\"p\"},\"key-shares\"),\" will default to \",mdx(\"strong\",{parentName:\"p\"},\"1\"),\" no matter what value you set.\"),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"First, initialize a rekeying operation. The flags represent the \",mdx(\"strong\",{parentName:\"p\"},`newly\ndesired`),\" number of keys and threshold:\"),mdx(\"pre\",e({},{className:\"language-shell-session\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault operator rekey -init -key-shares\",mdx(\"span\",e({parentName:\"span\"},{className:\"token operator\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token number\"}),\"3\"),\" -key-threshold\",mdx(\"span\",e({parentName:\"span\"},{className:\"token operator\"}),\"=\"),mdx(\"span\",e({parentName:\"span\"},{className:\"token number\"}),\"2\"))),`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`This will generate a nonce value and start the rekeying process. All other\nunseal keys must also provide this nonce value. This nonce value is not a\nsecret, so it is safe to distribute over insecure channels like chat, email, or\ncarrier pigeon.`),mdx(\"pre\",e({},{className:\"language-text\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-text\"}),\"Key               Value\",`\n`,\"---               -----\",`\n`,\"Nonce             dc1aec3b-ae67-5780-b4b5-2a10ca05b17c\",`\n`,\"Started           true\",`\n`,\"Rekey Progress    0/1\",`\n`,\"New Shares        3\",`\n`,\"New Threshold     2\",`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"Each unseal key holder runs the following command and enters their unseal key:\"),mdx(\"pre\",e({},{className:\"language-shell-session\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault operator rekey -nonce\",mdx(\"span\",e({parentName:\"span\"},{className:\"token operator\"}),\"=\"))),mdx(\"span\",e({parentName:\"code\"},{className:\"token output\"}),\"<nonce>\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token output\"}),\"Rekey operation nonce: dc1aec3b-ae67-5780-b4b5-2a10ca05b17c\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"token output\"}),\"Key (will be hidden):\"),`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`When the final unseal key holder enters their key, Vault will output the new\nunseal keys:`),mdx(\"pre\",e({},{className:\"language-text\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-text\"}),\"Key 1: EDj4NZK6z5Y9rpr+TtihTulfdHvFzXtBYQk36dmBczuQ\",`\n`,\"Key 2: sCkM1i5BGGNDFk5GsqtVolWRPyd5mWn2eZG0gUySiCF7\",`\n`,\"Key 3: e5DUvDIH0cPU8Q+hh1KNVkkMc9lliliPVe9u3Fzbzv38\",`\n`,`\n`,\"Operation nonce: dc1aec3b-ae67-5780-b4b5-2a10ca05b17c\",`\n`,`\n`,\"Vault rekeyed with 3 keys and a key threshold of 2. Please\",`\n`,\"securely distribute the above keys. When the vault is re-sealed,\",`\n`,\"restarted, or stopped, you must provide at least 2 of these keys\",`\n`,\"to unseal it again.\",`\n`,`\n`,\"Vault does not store the master key. Without at least 2 keys,\",`\n`,\"your vault will remain permanently sealed.\",`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`Like the initialization process, Vault supports PGP encrypting the resulting\nunseal keys and creating backup encryption keys for disaster recovery.`),mdx(\"h2\",e({},{className:\"g-type-display-3\"}),mdx(\"a\",e({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#rotating-the-encryption-key\",\"aria-label\":\"rotating the encryption key permalink\"}),\"\\xBB\"),mdx(\"a\",e({parentName:\"h2\"},{className:\"__target-h\",id:\"rotating-the-encryption-key\",\"aria-hidden\":\"\"})),\"Rotating the Encryption Key\"),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`Unlike rekeying the Vault, rotating Vault's encryption key does not require a\nquorum of unseal keys. Anyone with the proper permissions in Vault can perform\nthe encryption key rotation.`),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"To trigger a key rotation, execute the command:\"),mdx(\"pre\",e({},{className:\"language-shell-session\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault operator rotate\")),`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),\"This will output the key version and installation time:\"),mdx(\"pre\",e({},{className:\"language-text\"}),mdx(\"code\",e({parentName:\"pre\"},{className:\"language-text\"}),\"Key Term: 2\",`\n`,\"Installation Time: ...\",`\n`)),mdx(\"p\",e({},{className:\"g-type-long-body\"}),`This will add a new key to the keyring. All new values written to the storage\nbackend will be encrypted with this new key.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"navData":[{"title":"Getting Started","path":"getting-started","filePath":"content/guides/getting-started.mdx"},{"title":"Vault Operations","routes":[{"title":"Overview","path":"operations","filePath":"content/guides/operations/index.mdx"},{"title":"Reference Architecture","path":"operations/reference-architecture","filePath":"content/guides/operations/reference-architecture.mdx"},{"title":"Vault HA with Consul","path":"operations/vault-ha-consul","filePath":"content/guides/operations/vault-ha-consul.mdx"},{"title":"Production Hardening","path":"operations/production","filePath":"content/guides/operations/production.mdx"},{"title":"Root Token Generation","path":"operations/generate-root","filePath":"content/guides/operations/generate-root.mdx"},{"title":"Rekeying & Rotating","path":"operations/rekeying-and-rotating","filePath":"content/guides/operations/rekeying-and-rotating.mdx"},{"title":"Building Plugin Backends","path":"operations/plugin-backends","filePath":"content/guides/operations/plugin-backends.mdx"},{"divider":true},{"title":"Replication Setup & Guidance","path":"operations/replication","filePath":"content/guides/operations/replication.mdx"},{"title":"Disaster Recovery Setup","path":"operations/disaster-recovery","filePath":"content/guides/operations/disaster-recovery.mdx"},{"title":"Mount Filter","path":"operations/mount-filter","filePath":"content/guides/operations/mount-filter.mdx"},{"title":"Multi-Tenant: Namespaces","path":"operations/multi-tenant","filePath":"content/guides/operations/multi-tenant.mdx"},{"title":"Vault Auto-unseal with AWS KMS","path":"operations/autounseal-aws-kms","filePath":"content/guides/operations/autounseal-aws-kms.mdx"},{"title":"Seal Wrap / FIPS 140-2","path":"operations/seal-wrap","filePath":"content/guides/operations/seal-wrap.mdx"},{"title":"Vault Cluster Monitoring","path":"operations/monitoring","filePath":"content/guides/operations/monitoring.mdx"},{"title":"Vault Deployment Guide","path":"operations/deployment-guide","filePath":"content/guides/operations/deployment-guide.mdx"},{"title":"Performance Standby Nodes","path":"operations/performance-nodes","filePath":"content/guides/operations/performance-nodes.mdx"}]},{"title":"Identity and Access Management","routes":[{"title":"Overview","path":"identity","filePath":"content/guides/identity/index.mdx"},{"title":"Secure Introduction of Vault Clients","path":"identity/secure-intro","filePath":"content/guides/identity/secure-intro.mdx"},{"title":"Policies","path":"identity/policies","filePath":"content/guides/identity/policies.mdx"},{"title":"ACL Policy Path Templating","path":"identity/policy-templating","filePath":"content/guides/identity/policy-templating.mdx"},{"title":"AppRole Pull Authentication","path":"identity/authentication","filePath":"content/guides/identity/authentication.mdx"},{"title":"AppRole with Terraform and Chef","path":"identity/approle-trusted-entities","filePath":"content/guides/identity/approle-trusted-entities.mdx"},{"title":"Tokens and Leases","path":"identity/lease","filePath":"content/guides/identity/lease.mdx"},{"title":"Identity - Entities & Groups","path":"identity/identity","filePath":"content/guides/identity/identity.mdx"},{"divider":true},{"title":"Sentinel Policies","path":"identity/sentinel","filePath":"content/guides/identity/sentinel.mdx"},{"title":"Control Groups","path":"identity/control-groups","filePath":"content/guides/identity/control-groups.mdx"}]},{"title":"Secrets Management","routes":[{"title":"Overview","path":"secret-mgmt","filePath":"content/guides/secret-mgmt/index.mdx"},{"title":"Static Secrets","path":"secret-mgmt/static-secrets","filePath":"content/guides/secret-mgmt/static-secrets.mdx"},{"title":"Versioned KV Secret Engine","path":"secret-mgmt/versioned-kv","filePath":"content/guides/secret-mgmt/versioned-kv.mdx"},{"title":"Secret as a Service","path":"secret-mgmt/dynamic-secrets","filePath":"content/guides/secret-mgmt/dynamic-secrets.mdx"},{"title":"DB Root Credential Rotation","path":"secret-mgmt/db-root-rotation","filePath":"content/guides/secret-mgmt/db-root-rotation.mdx"},{"title":"Cubbyhole Response Wrapping","path":"secret-mgmt/cubbyhole","filePath":"content/guides/secret-mgmt/cubbyhole.mdx"},{"title":"One-Time SSH Password","path":"secret-mgmt/ssh-otp","filePath":"content/guides/secret-mgmt/ssh-otp.mdx"},{"title":"Build Your Own CA","path":"secret-mgmt/pki-engine","filePath":"content/guides/secret-mgmt/pki-engine.mdx"},{"title":"Direct Application Integration","path":"secret-mgmt/app-integration","filePath":"content/guides/secret-mgmt/app-integration.mdx"}]},{"title":"Encryption as a Service","routes":[{"title":"Overview","path":"encryption","filePath":"content/guides/encryption/index.mdx"},{"title":"Encryption as a Service","path":"encryption/transit","filePath":"content/guides/encryption/transit.mdx"},{"title":"Java Application Demo","path":"encryption/spring-demo","filePath":"content/guides/encryption/spring-demo.mdx"},{"title":"Transit Secrets Re-wrapping","path":"encryption/transit-rewrap","filePath":"content/guides/encryption/transit-rewrap.mdx"}]}],"versions":[]},"__N_SSG":true}