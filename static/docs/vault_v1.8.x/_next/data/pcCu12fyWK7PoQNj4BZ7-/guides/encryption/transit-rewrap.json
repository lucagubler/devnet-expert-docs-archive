{"pageProps":{"currentPath":"encryption/transit-rewrap","frontMatter":{"layout":"guides","page_title":"Transit Secrets Re-wrapping - Guides","description":"The goal of this guide is to demonstrate one possible way to re-wrap data after\nrotating an encryption key in the transit engine in Vault."},"githubFileUrl":"https://github.com/hashicorp/vault/blob/main/website/content/guides/encryption/transit-rewrap.mdx","mdxSource":{"compiledSource":"var c=Object.defineProperty;var o=Object.prototype.hasOwnProperty;var p=Object.getOwnPropertySymbols,r=Object.prototype.propertyIsEnumerable;var l=(e,n,s)=>n in e?c(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s,a=(e,n)=>{for(var s in n||(n={}))o.call(n,s)&&l(e,s,n[s]);if(p)for(var s of p(n))r.call(n,s)&&l(e,s,n[s]);return e};var m=(e,n)=>{var s={};for(var t in e)o.call(e,t)&&n.indexOf(t)<0&&(s[t]=e[t]);if(e!=null&&p)for(var t of p(e))n.indexOf(t)<0&&r.call(e,t)&&(s[t]=e[t]);return s};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var t=s,{components:e}=t,n=m(t,[\"components\"]);return mdx(MDXLayout,a(a(a({},layoutProps),n),{components:e,mdxType:\"MDXLayout\"}),mdx(\"h1\",a({},{className:\"g-type-display-2\"}),mdx(\"a\",a({parentName:\"h1\"},{className:\"__permalink-h\",href:\"#transit-secrets-engine\",\"aria-label\":\"transit secrets engine permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h1\"},{className:\"__target-h\",id:\"transit-secrets-engine\",\"aria-hidden\":\"\"})),\"Transit Secrets Engine\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`In addition to being able to store secrets, Vault can encrypt/decrypt data that\nis stored elsewhere. The primary use of this is to allow applications to encrypt\ntheir data while still storing it in their primary data store. Vault does not\nstore the data.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The \",mdx(\"a\",a({parentName:\"p\"},{href:\"/docs/secrets/transit\"}),mdx(\"inlineCode\",{parentName:\"a\"},\"transit\"),\" secret engine\"),` handles\ncryptographic functions on data-in-transit, and often referred to as\n`,mdx(\"strong\",{parentName:\"p\"},mdx(\"em\",{parentName:\"strong\"},\"Encryption as a Service\")),` (EaaS). Both small amounts of arbitrary data, and\nlarge files such as images, can be protected with the transit engine. This EaaS\nfunction can augment or eliminate the need for Transparent Data Encryption (TDE)\nwith databases to encrypt the contents of a bucket, volume, and disk, etc.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"img\",a({parentName:\"p\"},{src:\"/img/vault-encryption.png\",alt:\"Encryption as a Service\"}))),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#encryption-key-rotation\",\"aria-label\":\"encryption key rotation permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"encryption-key-rotation\",\"aria-hidden\":\"\"})),\"Encryption Key Rotation\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`One of the benefits of using the Vault EaaS is its ability to easily rotate the\nencryption keys. Keys can be rotated manually by a human, or an automated\nprocess which invokes the key rotation API endpoint through `,mdx(\"inlineCode\",{parentName:\"p\"},\"cron\"),`, a CI\npipeline, a periodic Nomad batch job, Kubernetes Job, etc.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`The goal of this guide is to demonstrate an example for re-wrapping data after\nrotating an encryption key in the transit engine in Vault.`),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#reference-material\",\"aria-label\":\"reference material permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"reference-material\",\"aria-hidden\":\"\"})),\"Reference Material\"),mdx(\"ul\",null,mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"/guides/encryption/transit\"}),\"Encryption as a Service\")),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"/docs/secrets/transit\"}),\"Transit Secret Engine\")),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"/api/secret/transit\"}),\"Transit Secret Engine API\")),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"https://www.hashicorp.com/blog/transparent-data-encryption-in-the-modern-datacenter\"}),\"Transparent Data Encryption in the Modern Datacenter\"))),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#estimated-time-to-complete\",\"aria-label\":\"estimated time to complete permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"estimated-time-to-complete\",\"aria-hidden\":\"\"})),\"Estimated Time to Complete\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"30 minutes\"),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#personas\",\"aria-label\":\"personas permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"personas\",\"aria-hidden\":\"\"})),\"Personas\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The end-to-end scenario described in this guide involves two personas:\"),mdx(\"ul\",null,mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"li\"},\"security engineer\"),\" with privileged permissions to manage the encryption keys\"),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"li\"},\"app\"),\" with un-privileged permissions rewraps secrets via API\")),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#challenge\",\"aria-label\":\"challenge permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"challenge\",\"aria-hidden\":\"\"})),\"Challenge\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Vault maintains the versioned keyring and the operator can decide\nthe minimum version allowed for decryption operations. When data is\nencrypted using Vault, the resulting ciphertext is prepended with the version of\nthe key used to encrypt it.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`The following example shows data that was encrypted using the fourth version of\na particular encryption key:`),mdx(\"pre\",null,mdx(\"code\",a({parentName:\"pre\"},{}),\"vault:v4:ueizdCqCJ/YhowQSvmJyucnLfIUMd4S/nLTpGTcz64HXoY69dwOrqerFzOlhqg==\",`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"For example, an organization could decide that a key should be rotated \",mdx(\"em\",{parentName:\"p\"},`once a\nweek`),`, and that the minimum version allowed to decrypt records is the current\nversion as well as the previous two versions. If the current version is five,\nthen Vault would decrypt records that were sent to it with the following\nprefixes:`),mdx(\"ul\",null,mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"vault:\",mdx(\"strong\",{parentName:\"li\"},\"v5\"),\":lkjasfdlkjafdlkjsdflajsdf==\"),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"vault:\",mdx(\"strong\",{parentName:\"li\"},\"v4\"),\":asdfas9pirapirteradr33vvv==\"),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),\"vault:\",mdx(\"strong\",{parentName:\"li\"},\"v3\"),\":ouoiujarontoiue8987sdjf^1==\")),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`In this example, what would happen if you send Vault data that was encrypted\nwith the first or second version of the key (`,mdx(\"inlineCode\",{parentName:\"p\"},\"vault:v1:...\"),\" or \",mdx(\"inlineCode\",{parentName:\"p\"},\"vault:v2:...\"),\")?\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Vault would refuse to decrypt the data as the key used is less than the minimum\nkey version allowed.`),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#solution\",\"aria-label\":\"solution permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"solution\",\"aria-hidden\":\"\"})),\"Solution\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Luckily, Vault provides an easy way of re-wrapping encrypted data when a key is\nrotated. Using the rewrap API endpoint, a non-privileged Vault entity can send\ndata encrypted with an older version of the key to have it re-encrypted with the\nlatest version. The application performing the re-wrapping never interacts with\nthe decrypted data. The process of rotating the encryption key and rewrapping\nrecords could (and should) be completely `,mdx(\"strong\",{parentName:\"p\"},\"automated\"),`. Records could be updated\nslowly over time to lessen database load, or all at once at the time of\nrotation. The exact implementation will depend heavily on the needs of each\nparticular organization or application.`),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#prerequisites\",\"aria-label\":\"prerequisites permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"prerequisites\",\"aria-hidden\":\"\"})),\"Prerequisites\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`To perform the tasks described in this guide, you need to have a Vault\nenvironment. Refer to the `,mdx(\"a\",a({parentName:\"p\"},{href:\"/intro/getting-started/install\"}),`Getting\nStarted`),` guide to install Vault. Make sure\nthat your Vault server has been `,mdx(\"a\",a({parentName:\"p\"},{href:\"/intro/getting-started/deploy\"}),`initialized and\nunsealed`),\".\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`The following tools are required in order to successfully run the sample\napplication provided in this guide:`),mdx(\"ul\",null,mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"https://www.microsoft.com/net/download\"}),\".NET Core\")),mdx(\"li\",a({parentName:\"ul\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"https://docs.docker.com/install/\"}),\"Docker\"))),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Download the sample application code from\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"https://github.com/hashicorp/vault-guides/tree/master/encryption/vault-transit-rewrap\"}),\"vault-guides\"),`\nrepository to perform the steps described in this guide.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The \",mdx(\"inlineCode\",{parentName:\"p\"},\"vault-transit-rewrap-example\"),\" contains the following:\"),mdx(\"pre\",a({},{className:\"language-bash\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-bash\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\".\"),`\n`,\"\\u251C\\u2500\\u2500 AppDb.cs\",`\n`,\"\\u251C\\u2500\\u2500 DBHelper.cs\",`\n`,\"\\u251C\\u2500\\u2500 Program.cs\",`\n`,\"\\u251C\\u2500\\u2500 README.md\",`\n`,\"\\u251C\\u2500\\u2500 Record.cs\",`\n`,\"\\u251C\\u2500\\u2500 VaultClient.cs\",`\n`,\"\\u251C\\u2500\\u2500 WebHelper.cs\",`\n`,\"\\u2514\\u2500\\u2500 rewrap_example.csproj\",`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#policy-requirements\",\"aria-label\":\"policy requirements permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"policy-requirements\",\"aria-hidden\":\"\"})),\"Policy requirements\"),mdx(\"div\",a({},{className:\"alert alert-info g-type-body\",role:\"alert\"}),mdx(\"p\",a({parentName:\"div\"},{className:\"g-type-long-body\"}),\"\",mdx(\"strong\",{parentName:\"p\"},\"NOTE:\"),\" For the purpose of this guide, you can use the \",mdx(\"strong\",{parentName:\"p\"},mdx(\"inlineCode\",{parentName:\"strong\"},\"root\")),` token to work\nwith Vault. However, it is recommended that root tokens are only used for just\nenough initial setup or in emergencies. As a best practice, use tokens with\nan appropriate set of policies based on your role in the organization.`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`To perform all tasks demonstrated in this guide, your policy must include the\nfollowing permissions:`),mdx(\"pre\",a({},{className:\"language-shell\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Manage transit secret engine\"),`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"transit/keys/*\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"create\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"read\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"delete\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"list\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"sudo\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Enable transit secret engine\"),`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"sys/mounts/transit\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"create\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Write ACL policies\"),`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"sys/policy/*\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"create\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"read\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"delete\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"list\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Create tokens for verification & test\"),`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"auth/token/create\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"create\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),\", \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"sudo\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`If you are not familiar with policies, complete the\n`,mdx(\"a\",a({parentName:\"p\"},{href:\"/guides/identity/policies\"}),\"policies\"),\" guide.\"),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#steps\",\"aria-label\":\"steps permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"steps\",\"aria-hidden\":\"\"})),\"Steps\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"This guide introduces a sample \",mdx(\"em\",{parentName:\"p\"},\".Net\"),` application which automates the\nre-wrapping of the data using the latest encryption key.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`For the purpose of this guide, a MySQL database runs locally using Docker.\nHowever, these steps would work for an existing MySQL database by supplying the\nproper network information to your environment.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"You are going to perform the following steps:\"),mdx(\"ol\",null,mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step1\"}),\"Test database setup (Docker)\")),mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step2\"}),\"Enable the transit secret engine\")),mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step3\"}),\"Generate a new token for sample app\")),mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step4\"}),\"Run the sample application\")),mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step5\"}),\"Rotate the encryption keys\")),mdx(\"li\",a({parentName:\"ol\"},{className:\"g-type-long-body\"}),mdx(\"a\",a({parentName:\"li\"},{href:\"#step6\"}),\"Re-wrapping data programmatically\"))),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step1\",\"aria-label\":\"step 1 test database setup docker permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step1\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-1-test-database-setup-docker\",\"aria-hidden\":\"\"})),\"Step 1: Test database setup (Docker)\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`You need a database to test with. You can create one to test with easily using\nDocker:`),mdx(\"pre\",a({},{className:\"language-bash\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-bash\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Pull the latest mysql container image\"),`\n`,\"docker pull mysql/mysql-server:5.7\",`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Create a directory for our data (change the following line if running on Windows)\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"mkdir\"),\" ~/rewrap-data\",`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Run the container.  The following command creates a database named 'my_app',\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# specifies the root user password as 'root', and adds a user named vault\"),`\n`,\"docker run --name mysql-rewrap \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -p \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"3306\"),\":3306 \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -v ~/rewrap-data/var/lib/mysql \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -e \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"MYSQL_ROOT_PASSWORD\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\"root \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -e \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"MYSQL_ROOT_HOST\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\"% \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -e \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"MYSQL_DATABASE\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\"my_app \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -e \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"MYSQL_USER\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\"vault \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -e \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"MYSQL_PASSWORD\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\"vaultpw \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"  -d mysql/mysql-server:5.7\",`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step2\",\"aria-label\":\"step 2 enable the transit secret engine permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step2\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-2-enable-the-transit-secret-engine\",\"aria-hidden\":\"\"})),\"Step 2: Enable the transit secret engine\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"(\",mdx(\"strong\",{parentName:\"p\"},\"Persona:\"),\" security engineer)\"),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#cli-command\",\"aria-label\":\"cli command permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"cli-command\",\"aria-hidden\":\"\"})),\"CLI command\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Enable the \",mdx(\"inlineCode\",{parentName:\"p\"},\"transit\"),\" secret engine by executing the following command:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault secrets \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin class-name\"}),\"enable\"),\" transit\")),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),'Create an encryption key to use for transit named, \"my_app_key\".'),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault \",mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"write\"),\" -f transit/keys/my_app_key\")),`\n`)),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#api-call-using-curl\",\"aria-label\":\"api call using curl permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"api-call-using-curl\",\"aria-hidden\":\"\"})),\"API call using cURL\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Enable the \",mdx(\"inlineCode\",{parentName:\"p\"},\"transit\"),\" secret engine via API, use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/sys/mounts\"),\" endpoint:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: <TOKEN>\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --request POST \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --data <PARAMETERS> \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       <VAULT_ADDRESS>/v1/sys/mounts/transit\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Where \",mdx(\"inlineCode\",{parentName:\"p\"},\"<TOKEN>\"),\" is your valid token, and \",mdx(\"inlineCode\",{parentName:\"p\"},\"<PARAMETERS>\"),\" holds \",mdx(\"a\",a({parentName:\"p\"},{href:\"/api/system/mounts#enable-secrets-engine\"}),`configuration\nparameters`),\" of the secret engine.\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"To crate a new encryption key, use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"transit/keys/<key_name>\"),\" endpoint:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: <TOKEN>\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --request POST \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --data <PARAMETERS> \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       <VAULT_ADDRESS>/v1/transit/keys/<KEY_NAME>\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Where \",mdx(\"inlineCode\",{parentName:\"p\"},\"<PARAMETERS>\"),\" holds \",mdx(\"a\",a({parentName:\"p\"},{href:\"/api/secret/transit#create-key\"}),`configuration\nparameters`),\" to specify the key type.\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"p\"},\"Example:\")),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --request POST \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),`       --data '{\"type\": \"transit\"}' \\\\`),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/sys/mounts/transit\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The above example passes the \",mdx(\"strong\",{parentName:\"p\"},\"type\"),\" (\",mdx(\"inlineCode\",{parentName:\"p\"},\"transit\"),`) in the request payload which\nat the `,mdx(\"inlineCode\",{parentName:\"p\"},\"sys/mounts/transit\"),\" endpoint.\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),'Next, create an encryption key to use for transit named, \"my_app_key\".'),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --request POST \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/transit/keys/my_app_key\"),`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step3\",\"aria-label\":\"step 3 generate a new token for sample app permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step3\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-3-generate-a-new-token-for-sample-app\",\"aria-hidden\":\"\"})),\"Step 3: Generate a new token for sample app\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"(\",mdx(\"strong\",{parentName:\"p\"},\"Persona:\"),\" security engineer)\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),'Before generating a token, create a limited scope policy named, \"',mdx(\"strong\",{parentName:\"p\"},\"rewrap_example\"),`\"\nfor the sample application.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The ACL policy (\",mdx(\"inlineCode\",{parentName:\"p\"},\"rewrap_example.hcl\"),\") looks as follows:\"),mdx(\"pre\",a({},{className:\"language-shell\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell\"}),\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"transit/keys/my_app_key\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"read\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"transit/rewrap/my_app_key\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# This last policy is needed to seed the database as part of the example.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# It can be omitted if seeding is not required\"),`\n`,\"path \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"transit/encrypt/my_app_key\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  capabilities \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"update\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`)),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#cli-command-1\",\"aria-label\":\"cli command permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"cli-command-1\",\"aria-hidden\":\"\"})),\"CLI command\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Create \",mdx(\"inlineCode\",{parentName:\"p\"},\"rewrap_example\"),\" policy:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault policy \",mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"write\"),\" rewrap_example ./rewrap_example.hcl\")),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Finally, create a token to use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"rewrap_example\"),\" policy:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault token create -policy\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"rewrap_example\")),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"p\"},\"Example:\")),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault token create -policy\",mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"rewrap_example\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Key                Value\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"---                -----\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"token              68396128-82d8-002e-f289-1106944fee9f\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"token_accessor     75f05f43-6a5f-2eb1-5bb8-0de3c7cf0996\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"token_duration     768h\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"token_renewable    true\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"token_policies     [default rewrap_example]\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The generated token is what the sample application uses to connect to Vault.\"),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#api-call-using-curl-1\",\"aria-label\":\"api call using curl permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"api-call-using-curl-1\",\"aria-hidden\":\"\"})),\"API call using cURL\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"To create a policy via API, use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"/sys/policy\"),\" endpoint:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --request PUT --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       --data @payload.json \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/sys/policy/rewrap_example\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"cat\"),\" payload.json\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"{\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'  \"policy\": \"path \\\\\"transit/keys/my_app_key\\\\\" { capabilities = [\\\\\"read\\\\\"] } path \\\\\"transit/rewrap/my_app_key\\\\\" ... }\"'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"}\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Finally, create a token to use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"rewrap_example\"),\" policy:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" --request POST  \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),`       --data '{ \"policies\": [\"rewrap_example\"] }' \\\\`),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/auth/token/create | jq\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"{\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"request_id\": \"da8bde73-99ab-b435-a344-fb963b3a599f\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"lease_id\": \"\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"renewable\": false,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"lease_duration\": 0,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"data\": null,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"wrap_info\": null,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"warnings\": null,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"auth\": {'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"client_token\": \"997107d5-9049-8b4b-8f39-a33a458fd02d\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"accessor\": \"d400076b-4143-4d63-7473-a8cc52c73ba3\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"policies\": ['),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'     \"default\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'     \"rewrap-example\"'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"   ],\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"metadata\": null,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"lease_duration\": 2764800,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"renewable\": true,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"entity_id\": \"\"'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\" }\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"}\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The generated token is what the sample application uses to connect to Vault.\"),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step4\",\"aria-label\":\"step 4 run the sample application permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step4\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-4-run-the-sample-application\",\"aria-hidden\":\"\"})),\"Step 4: Run the sample application\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"(\",mdx(\"strong\",{parentName:\"p\"},\"Persona:\"),\" app)\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"You are now ready to run the app. Be sure to \",mdx(\"a\",a({parentName:\"p\"},{href:\"#prerequisites\"}),\"download\"),` the\nsample application code before beginning.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"p\"},\"Sample application\")),mdx(\"table\",null,mdx(\"thead\",{parentName:\"table\"},mdx(\"tr\",{parentName:\"thead\"},mdx(\"th\",a({parentName:\"tr\"},{align:null}),\"File\"),mdx(\"th\",a({parentName:\"tr\"},{align:null}),\"Description\"))),mdx(\"tbody\",{parentName:\"table\"},mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Program.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Starting point of this sample app (the \",mdx(\"inlineCode\",{parentName:\"td\"},\"Main()\"),\" method) is in this file. It reads the environment variable values, connects to Vault and the MySQL database. If the \",mdx(\"inlineCode\",{parentName:\"td\"},\"user_data\"),\" table does not exist, it creates it.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"DBHelper.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Defines a method to create the \",mdx(\"inlineCode\",{parentName:\"td\"},\"user_data\"),\" table if it does not exist. Finds and updates records that need to be rewrapped with the new key.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"AppDb.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Connects to the MySQL database.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Record.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Sample data record template.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"VaultClient.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Defines methods necessary to rewrap transit data.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"WebHelper.cs\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Helper code to seed the initial table schema.\")),mdx(\"tr\",{parentName:\"tbody\"},mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"rewrap_example.csproj\"),mdx(\"td\",a({parentName:\"tr\"},{align:null}),\"Project file for this sample app.\")))),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`The sample app retrieves the user token, Vault address, and the name of the\ntransit key through environment variables. Be sure to supply the token created\nin `,mdx(\"a\",a({parentName:\"p\"},{href:\"#step3\"}),\"Step 3\"),\":\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_TOKEN\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"))),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"<APP_TOKEN> \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"     VAULT_ADDR=<VAULT_ADDRESS> \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"     VAULT_TRANSIT_KEY=my_app_key \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"     SHOULD_SEED_USERS=true \\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"     dotnet run\"),`\n`)),mdx(\"blockquote\",null,mdx(\"p\",a({parentName:\"blockquote\"},{className:\"g-type-long-body\"}),`If you need to seed test data you can do so by including the\n`,mdx(\"inlineCode\",{parentName:\"p\"},\"SHOULD_SEED_USERS=true\"),\".\")),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"p\"},\"Example:\")),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_TOKEN\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token variable\"}),\"$TOKEN\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_ADDR\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"http://localhost:8200 \",mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_TRANSIT_KEY\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"my_app_key \",mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"SHOULD_SEED_USERS\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"true dotnet run\")),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Connecting to Vault server...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Created (if not exist) my_app DB\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Create (if not exist) user_data table\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Seeded the database...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Moving rewrap...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Current Key Version: 5\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Found 0 records to rewrap.\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"You can inspect the contents of the database with:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"docker \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin class-name\"}),\"exec\"),\" -it mysql-rewrap mysql -uroot -proot\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"mysql> DESC user_data;\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'mysql> SELECT * FROM user_data WHERE dob LIKE \"vault:v1%\" limit 10;'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"...data...\"),`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step5\",\"aria-label\":\"step 5 rotate the encryption keys permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step5\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-5-rotate-the-encryption-keys\",\"aria-hidden\":\"\"})),\"Step 5: Rotate the encryption keys\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"(\",mdx(\"strong\",{parentName:\"p\"},\"Persona:\"),\" security engineer)\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"The encryption key (\",mdx(\"inlineCode\",{parentName:\"p\"},\"my_app_key\"),\") can be rotated easily.\"),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#cli-command-2\",\"aria-label\":\"cli command permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"cli-command-2\",\"aria-hidden\":\"\"})),\"CLI command\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"To rotate the key, you write to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"transit/keys/<KEY_NAME>/rotate\"),\" path.\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault \",mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"write\"),\" -f transit/keys/my_app_key/rotate\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Success! Data written to: transit/keys/my_app_key/rotate\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Run the command a few times to generate several versions of the encryption key\nfor testing.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"To view the key information:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"vault \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin class-name\"}),\"read\"),\" transit/keys/my_app_key\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Key                       Value\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"---                       -----\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"allow_plaintext_backup    false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"deletion_allowed          false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"derived                   false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"exportable                false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"keys                      map[5:1519623974 6:1519623980 1:1519620952 2:1519623255 3:1519623285 4:1519623603]\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"latest_version            6\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"min_decryption_version    1\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"min_encryption_version    0\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"name                      my_app_key\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"supports_decryption       true\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"supports_derivation       true\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"supports_encryption       true\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"supports_signing          false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"type                      aes256-gcm96\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`You can see that in the above example the current version of the key is six.\nThere is no restriction about a minimum encryption key version, and any of the key\nversions can decrypt the data (`,mdx(\"inlineCode\",{parentName:\"p\"},\"min_decryption_version\"),\").\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Let's enforce the use of the encryption key at version five or later to decrypt\ndata.`),mdx(\"pre\",a({},{className:\"language-shell\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# replace '5' with the appropriate version\"),`\n`,\"$ vault \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"write\"),\" transit/keys/my_app_key/config \",mdx(\"span\",a({parentName:\"code\"},{className:\"token assign-left variable\"}),\"min_decryption_version\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"=\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"5\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Verify the changes were successful\"),`\n`,\"$ vault \",mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\"read\"),\" transit/keys/my_app_key\",`\n`,\"Key                       Value\",`\n`,\"---                       -----\",`\n`,\"allow_plaintext_backup    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,\"deletion_allowed          \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,\"derived                   \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,\"exportable                \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,\"keys                      map\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"[\"),mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"5\"),\":1519623974 \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"6\"),\":1519623980\",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"]\"),`\n`,\"latest_version            \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"6\"),`\n`,\"min_decryption_version    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"5\"),`\n`,\"min_encryption_version    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),`\n`,\"name                      my_app_key\",`\n`,\"supports_decryption       \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),`\n`,\"supports_derivation       \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),`\n`,\"supports_encryption       \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"true\"),`\n`,\"supports_signing          \",mdx(\"span\",a({parentName:\"code\"},{className:\"token boolean\"}),\"false\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\"type\"),\"                      aes256-gcm96\",`\n`)),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#api-call-using-curl-2\",\"aria-label\":\"api call using curl permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"api-call-using-curl-2\",\"aria-hidden\":\"\"})),\"API call using cURL\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"To rotate the encryption key via API, use the \",mdx(\"inlineCode\",{parentName:\"p\"},\"transit/keys/<KEY_NAME>/rotate\"),\" endpoint:\"),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --request POST --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/transit/keys/my_app_key/rotate\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Run the command a few times to generate several versions of the encryption key\nfor testing.`),mdx(\"pre\",a({},{className:\"language-shell\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token comment\"}),\"# Verify the changes were successful\"),`\n`,\"$ \",mdx(\"span\",a({parentName:\"code\"},{className:\"token function\"}),\"curl\"),\" --request GET --header \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"\\\\\"),`\n`,\"      https://localhost:8200/v1/transit/keys/my_app_key \",mdx(\"span\",a({parentName:\"code\"},{className:\"token operator\"}),\"|\"),\" jq\",`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"request_id\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"ed13436a-4816-2f51-0552-6a001e823548\"'),\",\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"lease_id\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"\"'),\",\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"renewable\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" false,\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"lease_duration\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),\",\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"data\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"allow_plaintext_backup\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" false,\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"deletion_allowed\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" false,\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"derived\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" false,\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"exportable\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" false,\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"keys\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"{\"),`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"1\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519620952\"),\",\",`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"2\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519623255\"),\",\",`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"3\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519623285\"),\",\",`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"4\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519623603\"),\",\",`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"5\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519623974\"),\",\",`\n`,\"      \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"6\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1519623980\"),`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\",\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"latest_version\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"6\"),\",\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"min_decryption_version\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"1\"),\",\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"min_encryption_version\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token number\"}),\"0\"),\",\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"name\"'),mdx(\"span\",a({parentName:\"code\"},{className:\"token builtin class-name\"}),\":\"),\" \",mdx(\"span\",a({parentName:\"code\"},{className:\"token string\"}),'\"my_app_key\"'),\",\",`\n`,\"    \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"..\"),\".\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),\",\",`\n`,\"  \",mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"..\"),\".\",`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token punctuation\"}),\"}\"),`\n`)),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`You can see that in the above example the current version of the key is six.\nThere is no restriction about the minimum encryption key version, and any of the key\nversions can decrypt the data (`,mdx(\"inlineCode\",{parentName:\"p\"},\"min_decryption_version\"),\").\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Let's enforce the use of the encryption key at version five or later to decrypt the\ndata.`),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --request POST --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),`       --data '{ \"min_decryption_version\": 5 }'`),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/transit/keys/my_app_key/config\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"#\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"Verify the changes were successful\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token function\"}),\"curl\"),\" --request GET --header \",mdx(\"span\",a({parentName:\"span\"},{className:\"token string\"}),'\"X-Vault-Token: ...\"'),\" \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"       https://localhost:8200/v1/transit/keys/my_app_key | jq\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"{\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\" ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),' \"data\": {'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"   ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"keys\": {'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'     \"5\": 1519623974,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'     \"6\": 1519623980'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"   },\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"latest_version\": 6,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"min_decryption_version\": 5,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"min_encryption_version\": 0,'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'   \"name\": \"my_app_key\",'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"   ...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"  },\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"}\"),`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#step6\",\"aria-label\":\"step 6 programmatically re wrap the data permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h __compat\",id:\"step6\",\"aria-hidden\":\"\"})),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"step-6-programmatically-re-wrap-the-data\",\"aria-hidden\":\"\"})),\"Step 6: Programmatically re-wrap the data\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"(\",mdx(\"strong\",{parentName:\"p\"},\"Persona:\"),\" app)\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Now you have records in the database and you have updated our minimum key\nversion. You can run the application again and should see it update records as\nappropriate. Remember you can inspect records using the MySQL shell (see above).`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),mdx(\"strong\",{parentName:\"p\"},\"Example:\")),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_TOKEN\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"2616214b-6868-3589-b443-0330d7915882 \",mdx(\"span\",a({parentName:\"span\"},{className:\"token assign-left variable\"}),\"VAULT_ADDR\"),mdx(\"span\",a({parentName:\"span\"},{className:\"token operator\"}),\"=\"),\"http://localhost:8200 \")),mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"\\\\\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"          VAULT_TRANSIT_KEY=my_app_key SHOULD_SEED_USERS=true dotnet run\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Connecting to Vault server...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Created (if not exist) my_app DB\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Create (if not exist) user_data table\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Seeded the database...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Current Key Version: 6\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Found 3500 records to rewrap.\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Wrapped another 10 records: 10 so far...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Wrapped another 10 records: 20 so far...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Wrapped another 10 records: 30 so far...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"...\"),`\n`)),mdx(\"h4\",a({},{className:\"g-type-display-5\"}),mdx(\"a\",a({parentName:\"h4\"},{className:\"__permalink-h\",href:\"#validation\",\"aria-label\":\"validation permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h4\"},{className:\"__target-h\",id:\"validation\",\"aria-hidden\":\"\"})),\"Validation\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`The application has now re-wrapped all records with the latest key. You can\nverify this by running the application again, or by inspecting the records using the\nMySQL client.`),mdx(\"pre\",a({},{className:\"language-shell-session\"}),mdx(\"code\",a({parentName:\"pre\"},{className:\"language-shell-session\"}),mdx(\"span\",a({parentName:\"code\"},{className:\"token command\"}),mdx(\"span\",a({parentName:\"span\"},{className:\"token shell-symbol important\"}),\"$\"),\" \",mdx(\"span\",a({parentName:\"span\"},{className:\"token bash language-bash\"}),\"docker \",mdx(\"span\",a({parentName:\"span\"},{className:\"token builtin class-name\"}),\"exec\"),\" -it mysql-rewrap mysql -uroot -proot\")),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"...\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"mysql> DESC user_data;\"),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'mysql> SELECT * FROM user_data WHERE dob LIKE \"vault:v1%\" limit 10;'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"Empty set (0.00 sec)\"),`\n`,`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),'mysql> SELECT * FROM user_data WHERE dob LIKE \"vault:v6%\" limit 10;'),`\n`,mdx(\"span\",a({parentName:\"code\"},{className:\"token output\"}),\"...data...\"),`\n`)),mdx(\"h3\",a({},{className:\"g-type-display-4\"}),mdx(\"a\",a({parentName:\"h3\"},{className:\"__permalink-h\",href:\"#conclusion\",\"aria-label\":\"conclusion permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h3\"},{className:\"__target-h\",id:\"conclusion\",\"aria-hidden\":\"\"})),\"Conclusion\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`An application similar to this could be scheduled via cron, run periodically as\na `,mdx(\"a\",a({parentName:\"p\"},{href:\"https://www.nomadproject.io/docs/job-specification/periodic\"}),`Nomad batch\njob`),`, or\nexecuted in a variety of other ways. You could also modify it to re-wrap a\nlimited number of records at a time so as to not put undue strain on the\ndatabase. The final implementation should be based upon the needs and design\ngoals specific to each organization or application.`),mdx(\"h2\",a({},{className:\"g-type-display-3\"}),mdx(\"a\",a({parentName:\"h2\"},{className:\"__permalink-h\",href:\"#next-steps\",\"aria-label\":\"next steps permalink\"}),\"\\xBB\"),mdx(\"a\",a({parentName:\"h2\"},{className:\"__target-h\",id:\"next-steps\",\"aria-hidden\":\"\"})),\"Next Steps\"),mdx(\"p\",a({},{className:\"g-type-long-body\"}),`Since the main focus of this guide was to programmatically rewrap your secrets\nusing the latest encryption key, the token used by the sample application was\ngenerated manually. In a production environment, you'll want to pass the token in\na more secure manner. Refer to the `,mdx(\"a\",a({parentName:\"p\"},{href:\"/guides/secret-mgmt/cubbyhole\"}),`Cubbyhole Response\nWrapping`),` guide to wrap the token so that only the\nexpecting app can unwrap to obtain the token.`),mdx(\"p\",a({},{className:\"g-type-long-body\"}),\"Also, refer to the \",mdx(\"a\",a({parentName:\"p\"},{href:\"/guides/identity/authentication\"}),`AppRole Pull\nAuthentication`),` to generate tokens for\napps using the AppRole auth method.`))}MDXContent.isMDXComponent=!0;\n","scope":{}},"navData":[{"title":"Getting Started","path":"getting-started","filePath":"content/guides/getting-started.mdx"},{"title":"Vault Operations","routes":[{"title":"Overview","path":"operations","filePath":"content/guides/operations/index.mdx"},{"title":"Reference Architecture","path":"operations/reference-architecture","filePath":"content/guides/operations/reference-architecture.mdx"},{"title":"Vault HA with Consul","path":"operations/vault-ha-consul","filePath":"content/guides/operations/vault-ha-consul.mdx"},{"title":"Production Hardening","path":"operations/production","filePath":"content/guides/operations/production.mdx"},{"title":"Root Token Generation","path":"operations/generate-root","filePath":"content/guides/operations/generate-root.mdx"},{"title":"Rekeying & Rotating","path":"operations/rekeying-and-rotating","filePath":"content/guides/operations/rekeying-and-rotating.mdx"},{"title":"Building Plugin Backends","path":"operations/plugin-backends","filePath":"content/guides/operations/plugin-backends.mdx"},{"divider":true},{"title":"Replication Setup & Guidance","path":"operations/replication","filePath":"content/guides/operations/replication.mdx"},{"title":"Disaster Recovery Setup","path":"operations/disaster-recovery","filePath":"content/guides/operations/disaster-recovery.mdx"},{"title":"Mount Filter","path":"operations/mount-filter","filePath":"content/guides/operations/mount-filter.mdx"},{"title":"Multi-Tenant: Namespaces","path":"operations/multi-tenant","filePath":"content/guides/operations/multi-tenant.mdx"},{"title":"Vault Auto-unseal with AWS KMS","path":"operations/autounseal-aws-kms","filePath":"content/guides/operations/autounseal-aws-kms.mdx"},{"title":"Seal Wrap / FIPS 140-2","path":"operations/seal-wrap","filePath":"content/guides/operations/seal-wrap.mdx"},{"title":"Vault Cluster Monitoring","path":"operations/monitoring","filePath":"content/guides/operations/monitoring.mdx"},{"title":"Vault Deployment Guide","path":"operations/deployment-guide","filePath":"content/guides/operations/deployment-guide.mdx"},{"title":"Performance Standby Nodes","path":"operations/performance-nodes","filePath":"content/guides/operations/performance-nodes.mdx"}]},{"title":"Identity and Access Management","routes":[{"title":"Overview","path":"identity","filePath":"content/guides/identity/index.mdx"},{"title":"Secure Introduction of Vault Clients","path":"identity/secure-intro","filePath":"content/guides/identity/secure-intro.mdx"},{"title":"Policies","path":"identity/policies","filePath":"content/guides/identity/policies.mdx"},{"title":"ACL Policy Path Templating","path":"identity/policy-templating","filePath":"content/guides/identity/policy-templating.mdx"},{"title":"AppRole Pull Authentication","path":"identity/authentication","filePath":"content/guides/identity/authentication.mdx"},{"title":"AppRole with Terraform and Chef","path":"identity/approle-trusted-entities","filePath":"content/guides/identity/approle-trusted-entities.mdx"},{"title":"Tokens and Leases","path":"identity/lease","filePath":"content/guides/identity/lease.mdx"},{"title":"Identity - Entities & Groups","path":"identity/identity","filePath":"content/guides/identity/identity.mdx"},{"divider":true},{"title":"Sentinel Policies","path":"identity/sentinel","filePath":"content/guides/identity/sentinel.mdx"},{"title":"Control Groups","path":"identity/control-groups","filePath":"content/guides/identity/control-groups.mdx"}]},{"title":"Secrets Management","routes":[{"title":"Overview","path":"secret-mgmt","filePath":"content/guides/secret-mgmt/index.mdx"},{"title":"Static Secrets","path":"secret-mgmt/static-secrets","filePath":"content/guides/secret-mgmt/static-secrets.mdx"},{"title":"Versioned KV Secret Engine","path":"secret-mgmt/versioned-kv","filePath":"content/guides/secret-mgmt/versioned-kv.mdx"},{"title":"Secret as a Service","path":"secret-mgmt/dynamic-secrets","filePath":"content/guides/secret-mgmt/dynamic-secrets.mdx"},{"title":"DB Root Credential Rotation","path":"secret-mgmt/db-root-rotation","filePath":"content/guides/secret-mgmt/db-root-rotation.mdx"},{"title":"Cubbyhole Response Wrapping","path":"secret-mgmt/cubbyhole","filePath":"content/guides/secret-mgmt/cubbyhole.mdx"},{"title":"One-Time SSH Password","path":"secret-mgmt/ssh-otp","filePath":"content/guides/secret-mgmt/ssh-otp.mdx"},{"title":"Build Your Own CA","path":"secret-mgmt/pki-engine","filePath":"content/guides/secret-mgmt/pki-engine.mdx"},{"title":"Direct Application Integration","path":"secret-mgmt/app-integration","filePath":"content/guides/secret-mgmt/app-integration.mdx"}]},{"title":"Encryption as a Service","routes":[{"title":"Overview","path":"encryption","filePath":"content/guides/encryption/index.mdx"},{"title":"Encryption as a Service","path":"encryption/transit","filePath":"content/guides/encryption/transit.mdx"},{"title":"Java Application Demo","path":"encryption/spring-demo","filePath":"content/guides/encryption/spring-demo.mdx"},{"title":"Transit Secrets Re-wrapping","path":"encryption/transit-rewrap","filePath":"content/guides/encryption/transit-rewrap.mdx"}]}],"versions":[]},"__N_SSG":true}