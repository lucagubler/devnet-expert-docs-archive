<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Anthon van der Neut" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Departure from previous API - yaml</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        
        
    
      <script>
        // Current page data
        var mkdocs_page_name = "Departure from previous API";
        var mkdocs_page_input_path = "api.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
<script async type="text/javascript" src="../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="yaml" /><meta name="readthedocs-version-slug" content="latest" /><meta name="readthedocs-resolver-filename" content="/api/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../index.html" class="icon icon-home"> yaml
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="https://yaml.readthedocs.io/en/latest/search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installing</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../basicuse/index.html">Basic Usage</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dumpcls/index.html">Working with Python classes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../detail/index.html">Details</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../example/index.html">Examples</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="index.html">Departure from previous API</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="index.html#loading">Loading</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="index.html#duplicate-keys">Duplicate keys</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="index.html#dumping-a-multi-document-yaml-stream">Dumping a multi-document YAML stream</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="index.html#dumping">Dumping</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="index.html#controls">Controls</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="index.html#transparent-usage-of-new-and-old-api">Transparent usage of new and old API</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="index.html#reason-for-api-change">Reason for API change</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pyyaml/index.html">Differences with PyYAML</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">yaml</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Departure from previous API</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="departure-from-previous-api">Departure from previous API<a class="headerlink" href="index.html#departure-from-previous-api" title="Permanent link">&para;</a></h1>
<p>With version 0.15.0 <code>ruamel.yaml</code> starts to depart from the previous
(PyYAML) way of loading and dumping. During a transition period the
original <code>load()</code> and <code>dump()</code> in its various formats will still be
supported, but this is not guaranteed to be so with the transition to
1.0.</p>
<p>At the latest with 1.0, but possible earlier transition error and
warning messages will be issued, so any packages depending on
ruamel.yaml should pin the version with which they are testing.</p>
<p>Up to 0.15.0, the loaders (<code>load()</code>, <code>safe_load()</code>, <code>round_trip_load()</code>,
<code>load_all</code>, etc.) took, apart from the input stream, a <code>version</code>
argument to allow downgrading to YAML 1.1, sometimes needed for
documents without directive. When round-tripping, there was an option to
preserve quotes.</p>
<p>Up to 0.15.0, the dumpers (<code>dump()</code>, <code>safe_dump</code>, <code>round_trip_dump()</code>,
<code>dump_all()</code>, etc.) had a plethora of arguments, some inherited from
<code>PyYAML</code>, some added in <code>ruamel.yaml</code>. The only required argument is the
<code>data</code> to be dumped. If the stream argument is not provided to the
dumper, then a string representation is build up in memory and returned
to the caller.</p>
<p>Starting with 0.15.0 <code>load()</code> and <code>dump()</code> are methods on a <code>YAML</code>
instance and only take the stream, resp. the data and stream argument.
All other parameters are set on the instance of <code>YAML</code> before calling
<code>load()</code> or <code>dump()</code></p>
<p>Before 0.15.0 you could do:</p>
<pre><code class="language-python">from pathlib import Path
from ruamel import yaml

data = yaml.safe_load(&quot;abc: 1&quot;)
out = Path('/tmp/out.yaml')
with out.open('w') as fp:
    yaml.safe_dump(data, fp, default_flow_style=False)
</code></pre>
<p>after:</p>
<pre><code class="language-python">from pathlib import Path
from ruamel.yaml import YAML

yaml = YAML(typ='safe')
yaml.default_flow_style = False
data = yaml.load(&quot;abc: 1&quot;)
out = Path('/tmp/out.yaml')
yaml.dump(data, out)
</code></pre>
<p>If you previously used a keyword argument <code>explicit_start=True</code> you now
do <code>yaml.explicit_start = True</code> before calling <code>dump()</code>. The <code>Loader</code>
and <code>Dumper</code> keyword arguments are not supported that way. You can
provide the <code>typ</code> keyword to <code>rt</code> (default), <code>safe</code>, <code>unsafe</code> or <code>base</code>
(for round-trip load/dump, safe_load/dump, load/dump resp. using the
BaseLoader / BaseDumper. More fine-control is possible by setting the
attributes <code>.Parser</code>, <code>.Constructor</code>, <code>.Emitter</code>, etc., to the class of
the type to create for that stage (typically a subclass of an existing
class implementing that).</p>
<p>The default loader (<code>typ='rt'</code>) is a direct derivative of the safe
loader, without the methods to construct arbitrary Python objects that
make the <code>unsafe</code> loader unsafe, but with the changes needed for
round-trip preservation of comments, etc.. For trusted Python classes a
constructor can of course be added to the round-trip or safe-loader, but
this has to be done explicitly (<code>add_constructor</code>).</p>
<p>All data is dumped (not just for round-trip-mode) with
<code>.allow_unicode = True</code></p>
<p>You can of course have multiple YAML instances active at the same time,
with different load and/or dump behaviour.</p>
<p>Initially only the typical operations are supported, but in principle
all functionality of the old interface will be available via <code>YAML</code>
instances (if you are using something that isn\'t let me know).</p>
<p>If a parse or dump fails, and throws and exception, the state of the
<code>YAML()</code> instance is not guaranteed to be able to handle further
processing. You should, at that point to recreate the YAML instance
before proceeding.</p>
<h2 id="loading">Loading<a class="headerlink" href="index.html#loading" title="Permanent link">&para;</a></h2>
<h3 id="duplicate-keys">Duplicate keys<a class="headerlink" href="index.html#duplicate-keys" title="Permanent link">&para;</a></h3>
<p>In JSON mapping keys should be unique, in YAML they must be unique.
PyYAML never enforced this although the YAML 1.1 specification already
required this.</p>
<p>In the new API (starting 0.15.1) duplicate keys in mappings are no
longer allowed by default. To allow duplicate keys in mappings:</p>
<pre><code class="language-python">yaml = ruamel.yaml.YAML()
yaml.allow_duplicate_keys = True
yaml.load(stream)
</code></pre>
<p>In the old API this is a warning starting with 0.15.2 and an error in
0.16.0.</p>
<p>When a duplicate key is found it and its value are discarded, as should
be done according to the <a href="http://yaml.org/spec/1.1/#id932806">YAML 1.1
specification</a>.</p>
<h2 id="dumping-a-multi-document-yaml-stream">Dumping a multi-document YAML stream<a class="headerlink" href="index.html#dumping-a-multi-document-yaml-stream" title="Permanent link">&para;</a></h2>
<p>The \"normal\" <code>dump_all</code> expected as first element a list of documents,
or something else the internals of the method can iterate over. To read
and write a multi-document you would either make a <code>list</code>:</p>
<pre><code class="language-lang-none">yaml = YAML()
data = list(yaml.load_all(in_path))
# do something on data[0], data[1], etc.
yaml.dump_all(data, out_path)
</code></pre>
<p>or create some function/object that would yield the <code>data</code> values.</p>
<p>What you now can do is create <code>YAML()</code> as an context manager. This works
for output (dumping) only, requires you to specify the output (file,
buffer, <code>Path</code>) at creation time, and doesn\'t support <code>transform</code>
(yet).</p>
<p>:</p>
<pre><code class="language-lang-none">with YAML(output=sys.stdout) as yaml:
        yaml.explicit_start = True
        for data in yaml.load_all(Path(multi_document_filename)):
            # do something on data
            yaml.dump(data)
</code></pre>
<p>Within the context manager, you cannot use the <code>dump()</code> with a second
(stream) argument, nor can you use <code>dump_all()</code>. The <code>dump()</code> within the
context of the <code>YAML()</code> automatically creates multi-document if called
more than once.</p>
<p>To combine multiple YAML documents from multiple files:</p>
<p>:</p>
<pre><code class="language-lang-none">list_of_filenames = ['x.yaml', 'y.yaml', ]
with YAML(output=sys.stdout) as yaml:
        yaml.explicit_start = True
        for path in list_of_filename:
            with open(path) as fp:
                yaml.dump(yaml.load(fp))
</code></pre>
<p>The output will be a valid, uniformly indented YAML file. Doing
<code>cat {x,y}.yaml</code> might result in a single document if there is not
document start marker at the beginning of <code>y.yaml</code></p>
<h2 id="dumping">Dumping<a class="headerlink" href="index.html#dumping" title="Permanent link">&para;</a></h2>
<h3 id="controls">Controls<a class="headerlink" href="index.html#controls" title="Permanent link">&para;</a></h3>
<p>On your <code>YAML()</code> instance you can set attributes e.g with:</p>
<pre><code>yaml = YAML(typ='safe', pure=True)
yaml.allow_unicode = False
</code></pre>
<p>available attributes include:</p>
<p><code>unicode_supplementary</code></p>
<p>:   Defaults to <code>True</code> if Python\'s Unicode size is larger than 2 bytes.
    Set to <code>False</code> to enforce output of the form <code>\U0001f601</code> (ignored
    if <code>allow_unicode</code> is <code>False</code>)</p>
<h2 id="transparent-usage-of-new-and-old-api">Transparent usage of new and old API<a class="headerlink" href="index.html#transparent-usage-of-new-and-old-api" title="Permanent link">&para;</a></h2>
<p>With 0.18 the entry functions for the  old API has been removed, so the
following now only makes sense if you use the old API on a pinned
old version or <code>ruamel.yaml</code>.</p>
<p>If you have multiple packages depending on <code>ruamel.yaml</code>, or install
your utility together with other packages not under your control, then
fixing your <code>install_requires</code> might not be so easy.</p>
<p>Depending on your usage you might be able to \"version\" your usage to
be compatible with both the old and the new. The following are some
examples all assuming <code>from ruamel import yaml</code> somewhere at the top of
your file and some <code>istream</code> and <code>ostream</code> apropriately opened for
reading resp. writing.</p>
<p>Loading and dumping using the <code>SafeLoader</code>:</p>
<pre><code>if ruamel.yaml.version_info &lt; (0, 15):
    data = yaml.safe_load(istream)
    yaml.safe_dump(data, ostream)
else:
    yml = ruamel.yaml.YAML(typ='safe', pure=True)  # 'safe' load and dump
    data = yml.load(istream)
    yml.dump(data, ostream)
</code></pre>
<p>Loading with the <code>CSafeLoader</code>, dumping with <code>RoundTripLoader</code>. You need
two <code>YAML</code> instances, but each of them can be re-used:</p>
<pre><code class="language-python">if ruamel.yaml.version_info &lt; (0, 15):
    data = yaml.load(istream, Loader=yaml.CSafeLoader)
    yaml.round_trip_dump(data, ostream, width=1000, explicit_start=True)
else:
    yml = ruamel.yaml.YAML(typ='safe')
    data = yml.load(istream)
    ymlo = ruamel.yaml.YAML()   # or yaml.YAML(typ='rt')
    ymlo.width = 1000
    ymlo.explicit_start = True
    ymlo.dump(data, ostream)
</code></pre>
<p>Loading and dumping from <code>pathlib.Path</code> instances using the
round-trip-loader:</p>
<pre><code class="language-lang-none"># in myyaml.py
if ruamel.yaml.version_info &lt; (0, 15):
    class MyYAML(yaml.YAML):
        def __init__(self):
            yaml.YAML.__init__(self)
            self.preserve_quotes = True
            self.indent(mapping=4, sequence=4, offset=2)
# in your code
try:
    from myyaml import MyYAML
except (ModuleNotFoundError, ImportError):
    if ruamel.yaml.version_info &gt;= (0, 15):
        raise

# some pathlib.Path
from pathlib import Path
inf = Path('/tmp/in.yaml')
outf = Path('/tmp/out.yaml')

if ruamel.yaml.version_info &lt; (0, 15):
    with inf.open() as ifp:
         data = yaml.round_trip_load(ifp, preserve_quotes=True)
    with outf.open('w') as ofp:
         yaml.round_trip_dump(data, ofp, indent=4, block_seq_indent=2)
else:
    yml = MyYAML()
    # no need for with statement when using pathlib.Path instances
    data = yml.load(inf)
    yml.dump(data, outf)
</code></pre>
<h2 id="reason-for-api-change">Reason for API change<a class="headerlink" href="index.html#reason-for-api-change" title="Permanent link">&para;</a></h2>
<p><code>ruamel.yaml</code> inherited the way of doing things from <code>PyYAML</code>. In
particular when calling the function <code>load()</code> or <code>dump()</code> temporary
instances of <code>Loader()</code> resp. <code>Dumper()</code> were created that were
discarded on termination of the function.</p>
<p>This way of doing things leads to several problems:</p>
<ul>
<li>
<p>it is virtually impossible to return information to the caller apart
    from the constructed data structure. E.g. if you would get a YAML
    document version number from a directive, there is no way to let the
    caller know apart from handing back special data structures. The
    same problem exists when trying to do on the fly analysis of a
    document for indentation width.</p>
</li>
<li>
<p>these instances were composites of the various load/dump steps and
    if you wanted to enhance one of the steps, you needed e.g. subclass
    the emitter and make a new composite (dumper) as well, providing all
    of the parameters (i.e. copy paste)</p>
<p>Alternatives, like making a class that returned a <code>Dumper</code> when
called and sets attributes before doing so, is cumbersome for
day-to-day use.</p>
</li>
<li>
<p>many routines (like <code>add_representer()</code>) have a direct global impact
    on all of the following calls to <code>dump()</code> and those are difficult if
    not impossible to turn back. This forces the need to subclass
    <code>Loaders</code> and <code>Dumpers</code>, a long time problem in PyYAML as some
    attributes were not <code>deep_copied</code> although a bug-report (and fix)
    had been available a long time.</p>
</li>
<li>
<p>If you want to set an attribute, e.g. to control whether literal
    block style scalars are allowed to have trailing spaces on a line
    instead of being dumped as double quoted scalars, you have to change
    the <code>dump()</code> family of routines, all of the <code>Dumpers()</code> as well as
    the actual functionality change in <code>emitter.Emitter()</code>. The
    functionality change takes changing 4 (four!) lines in one file, and
    being able to enable that another 50+ line changes (non-contiguous)
    in 3 more files resulting in diff that is far over 200 lines long.</p>
</li>
<li>
<p>replacing libyaml with something that doesn\'t both support <code>0o52</code>
    and <code>052</code> for the integer <code>42</code> (instead of <code>52</code> as per YAML 1.2) is
    difficult</p>
</li>
</ul>
<p>With <code>ruamel.yaml&gt;=0.15.0</code> the various steps \"know\" about the <code>YAML</code>
instance and can pick up setting, as well as report back information via
that instance. Representers, etc., are added to a reusable instance and
different YAML instances can co-exists.</p>
<p>This change eases development and helps prevent regressions.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../example/index.html" class="btn btn-neutral float-left" title="Examples"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../pyyaml/index.html" class="btn btn-neutral float-right" title="Differences with PyYAML">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../readthedocs-data.js"></script>
      
      
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
